---
output: html_document
params:
    PROJECT: #ASDA
    date_DQC:    # adsasd    
    report_dataframe: #dasdasd
---

```{r message=FALSE,echo=FALSE, warning=FALSE, error=FALSE, eval=TRUE}

PROJECT = params$PROJECT
date_DQC <- params$date_DQC
report_dataframe <- params$report_dataframe

```

Report start at **`r date_DQC`**

### `r paste(PROJECT, "report")`

```{r echo=FALSE, warning=FALSE}
# report_dataframe

mydf = report_dataframe[,-ncol(report_dataframe)]
orig_mydf = mydf

# colnames(mydf)  ######
# mydf[1,8] = 1   ######

for(i in 2:(ncol(mydf))){
  mydf[,i] = as.numeric(mydf[,i])
  orig_mydf[,i] = as.numeric(orig_mydf[,i])
}

sum_col = apply(mydf[,c(2:ncol(mydf))],1,sum)

# -----------------------

j=10
for(j in 1:nrow(mydf)){ 
  if(any(mydf[j,] == 1,na.rm = T)){
    if(mydf[j,2] == 2){
      mydf[j,3:ncol(mydf)] = NA
    }else{
      w = which(mydf[j,] == 1)
      
      if(w <= 7 ){
        mydf[j,(w+1):ncol(mydf)] = NA
      }else{
        if (w %in% c(8,9)){
          mydf[j,10:ncol(mydf)] = NA
        }
      }
    }
  }
}

# -----------------------

mydf[is.na(mydf)] = "white"

mydf$Offline[mydf$Offline == 1] = "firebrick1"
mydf$Offline[mydf$Offline == 2] = "grey"
mydf$Offline[mydf$Offline == 0] = "forestgreen"

mydf$err_empty[mydf$err_empty == 0] = "forestgreen"
mydf$err_empty[mydf$err_empty == 1] = "firebrick1"

mydf$err_logger_number[mydf$err_logger_number == 0] = "forestgreen"
mydf$err_logger_number[mydf$err_logger_number == 1] = "firebrick1"

mydf$err_structure[mydf$err_structure == 0] = "forestgreen"
mydf$err_structure[mydf$err_structure == 1] = "firebrick1"

mydf$err_no_new_data[mydf$err_no_new_data == 0] = "forestgreen"
mydf$err_no_new_data[mydf$err_no_new_data == 1] = "firebrick1"

mydf$err_overlap[mydf$err_overlap == 0] = "forestgreen"
mydf$err_overlap[mydf$err_overlap == 1] = "firebrick1"

mydf$err_missing_record[mydf$err_missing_record == 0] = "forestgreen"
mydf$err_missing_record[mydf$err_missing_record == 1] = "firebrick1"

mydf$err_restart_record[mydf$err_restart_record == 0] = "forestgreen"
mydf$err_restart_record[mydf$err_restart_record == 1] = "firebrick1"

mydf$err_date_missing[mydf$err_date_missing == 0] = "forestgreen"
mydf$err_date_missing[mydf$err_date_missing == 1] = "gold"

mydf$err_range_alert[mydf$err_range_alert == 0] = "forestgreen"
mydf$err_range_alert[mydf$err_range_alert == 1] = "gold"

mydf$err_out_of_range[mydf$err_out_of_range == 0] = "forestgreen"
mydf$err_out_of_range[mydf$err_out_of_range == 1] = "gold"

mydf$err_duplicates_rows[mydf$err_duplicates_rows == 0] = "forestgreen"
mydf$err_duplicates_rows[mydf$err_duplicates_rows == 1] = "gold"

mydf[is.na(mydf)] = "white"

colnames(mydf) = c("Station",
                   "Station Offline",
                   "File empty",
                   "Logger wrong number",
                   "File wrong structure",
                   "No new data",
                   "Data overlap",
                   "Data gap, no record",
                   "Data gap, restart record",
                   "Data gap",
                   "Data overrange",
                   "Data overrange physical",
                   "Rows duplicated")



mycolors = c("grey","firebrick1",  "gold","forestgreen", "white")
mycolors_value = c("Not evaluated!", "Critical!", "Warnings!","OK!", "---")

melt_final = melt(mydf,id.vars = "Station")
melt_final$value = factor(melt_final$value,levels = mycolors)

station_level = unique(melt_final$Station)

ggplot(melt_final, aes(x = variable, y = Station))+
  theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust =0),
        panel.background = element_rect(fill = "white", colour = "grey"),
        panel.border = element_rect(fill = "NA", colour = "white"))+
  geom_tile(aes(fill = value),colour = "black")+
  scale_fill_manual(name = "",values = mycolors,limits = mycolors,labels = mycolors_value, drop = FALSE)+
  scale_y_discrete(name = "Stations",limits = rev(station_level))+
  scale_x_discrete(name = "",position = "top")
##################################



```



```{r echo=FALSE, warning=FALSE}
# report_dataframe
ff = as.data.frame(report_dataframe,stringsAsFactors = F)

for(i in 2:(ncol(ff)-1)){
  ff[,i] = as.numeric(ff[,i])
}

r_link = ff$report_link
r_link_text =  r_link
# r_link_text =  gsub(pattern = "/",replacement = "\\\\",r_link)


w1 = which(is.na(r_link_text))
w2 = which(!is.na(r_link_text))


r_link_text[w1] = "---"
r_link_text[w2] ="Report available"

# d_folder_text[w3] = "No data file"
# d_folder_text[w4] ="Data available"

ff$report_link[w1]<- paste0(r_link_text[w1])
ff$report_link[w2]<- paste0("[", r_link_text[w2], "](\\", r_link[w2], ")")

# ff$report_link[w2]<- paste(r_link[w2],sep = "")

new_ff = ff[,c(1, ncol(ff))]
colnames(new_ff) = c("Station", "Report")


knitr::kable(new_ff,row.names = FALSE)

# datatable(new_ff)
```



Report end at **`r Sys.time()`**
